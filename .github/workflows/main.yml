name: Deploy Frontend

on:
  push:
    branches:
      - deploy
      - main

jobs:
  deploy:
    if: github.ref == 'refs/heads/deploy'
    runs-on: ubuntu-latest
    steps:
      - name: ğŸš€ Checkout Code
        uses: actions/checkout@v2

      - name: ğŸ”‘ Connect to VPS & Deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USERNAME }}
          key: ${{ secrets.PRIVATE_KEY }}
          port: ${{ secrets.SSH_PORT }}
          script_stop: true
          timeout: 600s  # Increase timeout to 10 minutes
          script: |
            echo "ğŸ”„ Loading environment variables..."
            source ~/.bashrc
            source ~/.profile

            echo "ğŸ’¾ Initializing NVM (if used)..."
            export NVM_DIR="$HOME/.nvm"
            [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh"

            echo "ğŸ“‚ Setting up project directory..."
            mkdir -p ~/apps/lms/frontend && cd ~/apps/lms/frontend

            if [ -d ".git" ]; then
              echo "ğŸ”„ Updating existing repository..."
              git reset --hard HEAD
              git pull origin deploy --rebase
            else
              echo "ğŸ“¥ Cloning repository for the first time..."
              git clone -b deploy https://github.com/pgvda/LMS-Supun-Front.git .
            fi

            echo "ğŸ“¦ Installing dependencies..."
            npm install --force

            echo "ğŸ› ï¸ Building project... (This may take a while)"
            npm run build

            echo "ğŸš€ Installing Serve & PM2..."
            npm install -g serve pm2

            echo "ğŸ’¡ Restarting PM2 service..."
            pm2 delete lms-frontend || true
            pm2 start serve --name "lms-frontend" -- -s build -l 3000
            pm2 save

            echo "âœ… Deployment completed successfully!"
